// Êñá‰ª∂Âêç: main_ui.js
"ui";

// ===================================================================
// UIÁïåÈù¢ÂíåÈÖçÁΩÆÊî∂ÈõÜ
// ===================================================================
ui.layout(
    <vertical>
        <vertical id="title_bar" padding="16dp 16dp 20dp 16dp">
            <text id="title_text" text="ËÅîÂä®Ëá™Âä®Ë¥¥Âõæ" textSize="24sp" gravity="center" textStyle="bold"/>
            <text id="subtitle_text" text="v5.1 (ÈÄüÂ∫¶ÂèØË∞ÉÁâà)" textSize="12sp" gravity="center" marginTop="4dp"/>
        </vertical>
        <horizontal id="nav_bar" w="*" h="50dp">
            <text id="tab_main" text="‰∏ªË¶ÅÂèÇÊï∞" layout_weight="1" gravity="center" textSize="14sp" h="*"/>
            <text id="tab_advanced" text="Â∑•‰ΩúÊµÅ" layout_weight="1" gravity="center" textSize="14sp" h="*"/>
            <text id="tab_sequence" text="Â∫èÂè∑ÈÖçÁΩÆ" layout_weight="1" gravity="center" textSize="14sp" h="*"/>
            <text id="tab_settings" text="Á≥ªÁªüËÆæÁΩÆ" layout_weight="1" gravity="center" textSize="14sp" h="*"/>
        </horizontal>
        <View w="*" h="2dp" id="nav_indicator"/>
        <FrameLayout id="pages_container" layout_weight="1">
            <ScrollView id="page_main">
                <vertical padding="16dp">
                    <text text="üéØ ‰∏ªË¶ÅÂèÇÊï∞ÈÖçÁΩÆ" textSize="20sp" textStyle="bold" marginBottom="20dp" gravity="center"/>
                    <vertical padding="20dp" marginBottom="16dp" id="container_size">
                        <text text="ÂÆΩÈ´òËÆæÁΩÆ" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="ÂÆΩÂ∫¶" textSize="14sp" w="60dp"/><input id="input_w" text="298" inputType="number" layout_weight="1" h="48dp" padding="12dp" textSize="14sp" margin="0 8dp"/><Switch id="switch_w" checked="true"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="È´òÂ∫¶" textSize="14sp" w="60dp"/><input id="input_h" text="268" inputType="number" layout_weight="1" h="48dp" padding="12dp" textSize="14sp" margin="0 8dp"/><Switch id="switch_h" checked="false"/></horizontal>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_pos">
                        <text text="xyÂùêÊ†áËÆæÁΩÆ" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="X ÂùêÊ†á" textSize="14sp" w="60dp"/><input id="input_x" text="57" inputType="numberSigned" layout_weight="1" h="48dp" padding="12dp" textSize="14sp" margin="0 8dp"/><Switch id="switch_x" checked="true"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="Y ÂùêÊ†á" textSize="14sp" w="60dp"/><input id="input_y" text="104" inputType="numberSigned" layout_weight="1" h="48dp" padding="12dp" textSize="14sp" margin="0 8dp"/><Switch id="switch_y" checked="true"/></horizontal>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_zoom">
                        <horizontal gravity="center_vertical" marginBottom="12dp"><text text="Áº©ÊîæËÆæÁΩÆ" textSize="16sp" textStyle="bold" layout_weight="1"/><Switch id="switch_z" checked="false"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="12dp"><text text="Ëµ∑Âßã" textSize="14sp" w="50dp"/><input id="input_z_start" text="0.7" inputType="numberDecimal" layout_weight="1" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/><text text="‚Üí" textSize="16sp" margin="0 4dp"/><input id="input_z" text="1.0" inputType="numberDecimal" layout_weight="1" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/><text text="ÂÄç" textSize="14sp" marginLeft="4dp"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="12dp"><text text="ÁªàÊ≠¢‰∫éÁ¨¨" textSize="14sp" w="70dp"/><input id="input_z_end" text="4" inputType="number" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp"/><text text="Âº†" textSize="14sp" marginLeft="8dp"/></horizontal>
                        <vertical marginTop="10dp">
                            <text text="ÁîªÂ∏É / ÈîöÁÇπÂÆö‰πâ" textSize="14sp" textColor="#2c3e50"/>
                            <horizontal gravity="center_vertical">
                                <text text="ËÉåÊôØÂ∞∫ÂØ∏" textSize="14sp" w="70dp"/>
                                <input id="input_bg_width" text="552" inputType="number" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/>
                                <text text="√ó" textSize="16sp" margin="0 4dp"/>
                                <input id="input_bg_height" text="476" inputType="number" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/>
                            </horizontal>
                        </vertical>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_advanced">
                        <text text="È´òÁ∫ßËÆæÁΩÆ" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="‰∏çÈÄèÊòéÂ∫¶" textSize="14sp" layout_weight="1"/><input id="input_opacity" text="80" inputType="number" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp"/><Switch id="checkbox_opacity" checked="false" marginLeft="8dp"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="ÂõæÂ±ÇÂè†Âä†" textSize="14sp" layout_weight="1"/><input id="input_blendmode" text="Êª§Ëâ≤" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp"/><Switch id="checkbox_blendmode" checked="false" marginLeft="8dp"/></horizontal>
                        <horizontal gravity="center_vertical" marginBottom="16dp"><text text="Ê∑°ÂÖ•ÊïàÊûúËá≥Á¨¨" textSize="14sp"/><input id="fadein_end" text="3" inputType="number" w="60dp" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/><text text="Âº†" textSize="14sp" layout_weight="1"/><Switch id="checkbox_fadein" checked="false" marginLeft="8dp"/></horizontal>
                        <horizontal gravity="center_vertical"><text text="Ê∑°Âá∫ÊïàÊûú‰ªéÁ¨¨" textSize="14sp"/><input id="fadeout_start" text="7" inputType="number" w="60dp" h="44dp" padding="8dp" gravity="center" textSize="14sp" margin="0 4dp"/><text text="Âº†Ëµ∑" textSize="14sp" layout_weight="1"/><Switch id="checkbox_fadeout" checked="false" marginLeft="8dp"/></horizontal>
                    </vertical>
                    <text id="status_text" text="Áä∂ÊÄÅÔºöËØ∑ÈÖçÁΩÆÂèÇÊï∞" textSize="14sp" gravity="center" padding="16dp" marginBottom="16dp"/>
                </vertical>
            </ScrollView>
            <ScrollView id="page_advanced" visibility="gone">
                <vertical padding="16dp">
                    <text text="‚öôÔ∏è ÂèØËßÜÂåñÂ∑•‰ΩúÊµÅÊûÑÂª∫Âô®" textSize="20sp" textStyle="bold" marginBottom="20dp" gravity="center"/>
                    <vertical padding="20dp" marginBottom="16dp" id="container_module_pool">
                        <text text="ÂèØÁî®Ê®°Âùó (ÁÇπÂáªÊ∑ªÂä†)" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <HorizontalScrollView>
                            <LinearLayout id="module_buttons_container" orientation="horizontal"/>
                        </HorizontalScrollView>
                    </vertical>
                    <vertical padding="20dp" id="container_current_workflow">
                        <text text="ÂΩìÂâçÂ∑•‰ΩúÊµÅÂ∫èÂàó" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <text id="workflow_display" text="ÂèØ‰ªé‰∏äÊñπÁÇπÂáªÊ®°ÂùóÊù•ÊûÑÂª∫ÊµÅÁ®ã..." padding="12dp" w="*" minHeight="100dp" textSize="14sp" textColor="#2c3e50" bg="#ecf0f1" singleLine="false"/>
                        <horizontal marginTop="16dp">
                            <button id="btn_reset_workflow" text="ÈáçÁΩÆ‰∏∫ÈªòËÆ§" layout_weight="1" style="Widget.AppCompat.Button.Borderless.Colored"/>
                            <button id="btn_clear_workflow" text="Ê∏ÖÁ©∫" layout_weight="1" style="Widget.AppCompat.Button.Borderless.Colored"/>
                        </horizontal>
                    </vertical>
                </vertical>
            </ScrollView>
            <ScrollView id="page_sequence" visibility="gone">
                <vertical padding="16dp">
                    <text text="üìã Â∫èÂè∑ÈÖçÁΩÆÁÆ°ÁêÜ" textSize="20sp" textStyle="bold" marginBottom="20dp" gravity="center"/>
                    <vertical padding="20dp" marginBottom="16dp" id="container_ps_order">
                        <text text="PS Â∫èÂè∑ËÆæÁΩÆ (0=Á¨¨1Âº†)" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <input id="input_order" text="0,1,2,3,4,5,6,7,8,9" h="48dp" padding="12dp" textSize="14sp" marginBottom="12dp"/>
                        <horizontal>
                            <button id="btn_reverse" text="ÂèçËΩ¨ÊéíÂ∫è" layout_weight="1" h="44dp" style="Widget.AppCompat.Button.Borderless"/>
                            <button id="btn_forward" text="ÁîüÊàêÈªòËÆ§" layout_weight="1" h="44dp" style="Widget.AppCompat.Button.Borderless"/>
                            <button id="btn_clear" text="Ê∏ÖÁ©∫" layout_weight="1" h="44dp" style="Widget.AppCompat.Button.Borderless"/>
                        </horizontal>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_mt_order">
                        <text text="MT Â∫èÂè∑ËÆæÁΩÆ" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <input id="input_mt_order" text="0,1,2,3,4,5,6,7,8,9" h="48dp" padding="12dp" textSize="14sp"/>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_preprocess">
                        <text text="È¢ÑÂ§ÑÁêÜÂ∫èÂè∑" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <input id="input_preprocess_order" hint="‰æãÂ¶Ç 1,2,3" text="0,1,2" h="48dp" padding="12dp" textSize="14sp" marginBottom="12dp"/>
                        <button id="btn_preprocess" text="ÊâßË°åÈ¢ÑÂ§ÑÁêÜ" h="50dp" enabled="false" textSize="16sp"/>
                    </vertical>
                </vertical>
            </ScrollView>
            <ScrollView id="page_settings" visibility="gone">
                <vertical padding="16dp">
                    <text text="‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ" textSize="20sp" textStyle="bold" marginBottom="20dp" gravity="center"/>
                    <vertical padding="20dp" marginBottom="16dp" id="container_performance">
                        <text text="ÊÄßËÉΩ‰∏éÈÄüÂ∫¶" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <horizontal gravity="center_vertical" marginBottom="16dp">
                            <vertical layout_weight="1">
                                <text text="Âø´ÈÄüËæìÂÖ•Ê®°Âºè" textSize="14sp"/>
                                <text text="Êé®ËçêÂºÄÂêØ„ÄÇ‰ΩøÁî®ÊâãÂäøÊ®°ÊãüÔºåÂÆûÁé∞Èó™ÁîµËæìÂÖ•" textSize="12sp" textColor="#7f8c8d"/>
                            </vertical>
                             <Switch id="switch_fast_input" checked="true" marginLeft="8dp"/>
                        </horizontal>
                        
                        <!-- ==================== Êñ∞Â¢ûUIÂÖÉÁ¥† ==================== -->
                        <vertical id="container_fast_input_settings" marginLeft="8dp" marginTop="10dp">
                             <horizontal gravity="center_vertical">
                                <vertical layout_weight="1">
                                    <text text="Âø´ÈÄüÊ®°ÂºèÂª∂Ëøü" textSize="14sp"/>
                                    <text text="ÊØèÊ¨°ÁÇπÂáªÈó¥Èöî(ÊØ´Áßí), Âª∫ËÆÆ20-50" textSize="12sp" textColor="#7f8c8d"/>
                                </vertical>
                                <input id="input_fast_delay" text="30" inputType="number" w="80dp" h="44dp" padding="8dp" gravity="center" textSize="14sp"/>
                             </horizontal>
                        </vertical>
                        <!-- ================================================= -->

                        <horizontal gravity="center_vertical" id="container_slow_motion" marginTop="10dp">
                            <vertical layout_weight="1">
                                <text text="ÊÖ¢Âä®‰ΩúË∞ÉËØï" textSize="14sp"/>
                                <text text="ÂºÄÂêØÂêéÔºåÈ´òÈÄüËæìÂÖ•‰ºöÂèòÊÖ¢ÔºåÊñπ‰æøÊ£ÄÊü•ÁÇπÂáª‰ΩçÁΩÆ" textSize="12sp" textColor="#7f8c8d"/>
                            </vertical>
                             <Switch id="switch_slow_motion" checked="false" marginLeft="8dp"/>
                        </horizontal>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_delay">
                        <text text="Âª∂ËøüÈÖçÁΩÆ (ÊÖ¢ÈÄüÊ®°Âºè)" textSize="16sp" textStyle="bold" marginBottom="16dp"/>
                        <text text="ÂÖ≥Èó≠Âø´ÈÄüËæìÂÖ•Êó∂ÔºåÊ≠§Â§ÑÁöÑÂª∂ËøüÊâçÁîüÊïà" textSize="12sp" marginBottom="16dp"/>
                        <button id="btn_delay" text="ÊâìÂºÄÂª∂ËøüËÆæÁΩÆ" h="48dp" textSize="16sp"/>
                    </vertical>
                    <vertical padding="20dp" marginBottom="16dp" id="container_about">
                        <text text="ÁâàÊú¨Ôºöv5.1 (ÈÄüÂ∫¶ÂèØË∞ÉÁâà)" textSize="14sp" marginBottom="8dp"/>
                        <text text="ÂºÄÂèëËÄÖÔºöLiangShengÔºàby ÂáâÁ¨ôÔºâ" textSize="14sp" marginBottom="8dp"/>
                        <text text="QQ:3084510367.ÈÇÆÁÆ±Ôºö3084510367@qq.com" textSize="14sp" marginBottom="8dp"/>
                    </vertical>
                </vertical>
            </ScrollView>
        </FrameLayout>
        <vertical id="bottom_bar" paddingTop="8dp">
            <button id="btn_start" text="‰øùÂ≠òÈÖçÁΩÆÂπ∂ÂêØÂä®‰ªªÂä°" h="56dp" enabled="false" textSize="18sp" textStyle="bold" margin="8dp 16dp 16dp 16dp"/>
        </vertical>
    </vertical>
);

// ===================================================================
// UIÊéßÂà∂‰∏éÈÄªËæë
// ===================================================================
var configStorage = storages.create("LiangSheng_AutoTexture_Config");
var defaultWorkflow = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8'];
var currentWorkflow = defaultWorkflow.slice();

var stepMap = {
    'step1': { name: "Âä†ËΩΩPS" }, 'step2': { name: "ÈÄâÊã©MT" }, 'step3': { name: "Á≠âÂæÖÂä†ËΩΩ" },
    'step4': { name: "ËæìÂÖ•ÂèÇÊï∞" }, 'step5': { name: "Â∫îÁî®ÂèÇÊï∞" }, 'step6': { name: "È´òÁ∫ßËÆæÁΩÆ" },
    'step7': { name: "‰øùÂ≠ò" }, 'step8': { name: "Á°ÆËÆ§‰øùÂ≠ò" }, 'step9': { name: "‚ú®Ëá™ÂÆö‰πâ" }
};

function collectAllSettings(taskType) {
    return {
        task_type: taskType || 'main',
        w: ui.input_w.getText().toString(),
        h: ui.input_h.getText().toString(),
        x: ui.input_x.getText().toString(),
        y: ui.input_y.getText().toString(),
        switch_w: ui.switch_w.isChecked(),
        switch_h: ui.switch_h.isChecked(),
        switch_x: ui.switch_x.isChecked(),
        switch_y: ui.switch_y.isChecked(),
        switch_z: ui.switch_z.isChecked(),
        z_start: ui.input_z_start.getText().toString(),
        z_end_val: ui.input_z.getText().toString(),
        z_end_index: ui.input_z_end.getText().toString(),
        bg_width: ui.input_bg_width.getText().toString(),
        bg_height: ui.input_bg_height.getText().toString(),
        opacity: ui.input_opacity.getText().toString(),
        checkbox_opacity: ui.checkbox_opacity.isChecked(),
        blendmode: ui.input_blendmode.getText().toString(),
        checkbox_blendmode: ui.checkbox_blendmode.isChecked(),
        fadein_end: ui.fadein_end.getText().toString(),
        checkbox_fadein: ui.checkbox_fadein.isChecked(),
        fadeout_start: ui.fadeout_start.getText().toString(),
        checkbox_fadeout: ui.checkbox_fadeout.isChecked(),
        ps_order: ui.input_order.getText().toString(),
        mt_order: ui.input_mt_order.getText().toString(),
        preprocess_order: ui.input_preprocess_order.getText().toString(),
        fast_input: ui.switch_fast_input.isChecked(),
        slow_motion: ui.switch_slow_motion.isChecked(),
        fast_input_delay: ui.input_fast_delay.getText().toString(), // Êñ∞Â¢ûÔºöËØªÂèñÂø´ÈÄüÊ®°ÂºèÂª∂Ëøü
        workflow: currentWorkflow,
        delays: configStorage.get("delays", {})
    };
}

function launchWorker(taskType) {
    var validationFunc = (taskType === 'preprocess') ? validatePreprocessInput : validateAllInputs;
    if (!validationFunc()) {
        toast("ÂèÇÊï∞ÊúâËØØÔºåËØ∑Ê£ÄÊü•ÔºÅ");
        return;
    }
    
    var settings = collectAllSettings(taskType);
    configStorage.put("settings", settings);
    
    try {
        var workerPath = files.join(files.cwd(), "worker.js");
        if (!files.exists(workerPath)) {
            alert("ÈîôËØØ", "Êú™ÊâæÂà∞worker.jsÊñá‰ª∂ÔºÅËØ∑Á°Æ‰øùÂÆÉÂíåUIËÑöÊú¨Âú®Âêå‰∏Ä‰∏™Êñá‰ª∂Â§π‰∏ã„ÄÇ");
            return;
        }
        engines.execScriptFile(workerPath);
        toast("‰ªªÂä°Â∑≤Âú®ÂêéÂè∞ÂêØÂä®ÔºåËØ∑ËßÇÂØüÊÇ¨ÊµÆÁ™óÁä∂ÊÄÅ");
    } catch (e) {
        toast("ÂêØÂä®ÂêéÂè∞‰ªªÂä°Â§±Ë¥•: " + e.message);
        console.error("ÂêØÂä®worker.jsÂ§±Ë¥•: ", e);
    }
}

function openDelaySettings() {
    var delayUi = ui.inflate( <vertical padding="20dp" id="delay_root_view"> <text id="delay_title" text="‚è±Ô∏è Âª∂ËøüÂèÇÊï∞ÈÖçÁΩÆ" textSize="20sp" gravity="center" textStyle="bold" marginBottom="8dp"/> <text id="delay_subtitle" text="Âçï‰ΩçÔºöÊØ´Áßí (ms)" textSize="12sp" gravity="center" marginBottom="20dp"/> <vertical padding="16dp" marginBottom="16dp" id="delay_container_app"> <text id="delay_text_app" text="Â∫îÁî®ÂêØÂä®" textSize="16sp" textStyle="bold" marginBottom="12dp"/> <horizontal gravity="center_vertical" marginBottom="8dp"> <text text="PSÁºìÂÜ≤1" layout_weight="1" textSize="14sp"/> <input id="delay_ps_launch" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> <horizontal gravity="center_vertical" marginBottom="8dp"> <text text="PSÁºìÂÜ≤2" layout_weight="1" textSize="14sp"/> <input id="delay_mt_before" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> <horizontal gravity="center_vertical"> <text text="MTÁÇπÂáªÁâπÊïàÂõæÁºìÂÜ≤" layout_weight="1" textSize="14sp"/> <input id="delay_mt_after" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> </vertical> <vertical padding="16dp" marginBottom="16dp" id="delay_container_op"> <text id="delay_text_op" text="Êìç‰ΩúÂìçÂ∫î" textSize="16sp" textStyle="bold" marginBottom="12dp"/> <horizontal gravity="center_vertical" marginBottom="8dp"> <text text="ÁÇπÂáªÂêéÂª∂Ëøü" layout_weight="1" textSize="14sp"/> <input id="delay_ps_click" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> <horizontal gravity="center_vertical"> <text text="ËæìÂÖ•ÂâçÂª∂Ëøü" layout_weight="1" textSize="14sp"/> <input id="delay_before_input" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> </vertical> <vertical padding="16dp" marginBottom="20dp" id="delay_container_save"> <text id="delay_text_save" text="‰øùÂ≠òÊìç‰Ωú" textSize="16sp" textStyle="bold" marginBottom="12dp"/> <horizontal gravity="center_vertical" marginBottom="8dp"> <text text="‰øùÂ≠òÁÇπÂáªÂâç" layout_weight="1" textSize="14sp"/> <input id="delay_save_click1" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> <horizontal gravity="center_vertical" marginBottom="8dp"> <text text="Á°ÆËÆ§‰øùÂ≠ò" layout_weight="1" textSize="14sp"/> <input id="delay_save_click2" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> <horizontal gravity="center_vertical"> <text text="ÊúÄÁªàÂª∂Ëøü" layout_weight="1" textSize="14sp"/> <input id="delay_save_final" inputType="number" w="100dp" h="40dp" padding="8dp" gravity="center" textSize="14sp"/> </horizontal> </vertical> <horizontal> <button id="btn_close_delay" text="ÂèñÊ∂à" layout_weight="1" margin="0 8dp" h="48dp" textSize="16sp"/> <button id="btn_save_delay" text="‰øùÂ≠ò" layout_weight="1" margin="0 8dp" h="48dp" textSize="16sp"/> </horizontal> </vertical> );
    var savedDelays = configStorage.get("delays", { psLaunch: 1000, psClick: 1500, mtBeforeLaunch: 1000, mtAfterLaunch: 700, beforeInput: 850, saveClick1: 800, saveClick2: 100, saveFinal: 500 });
    delayUi.delay_ps_launch.setText(String(savedDelays.psLaunch));
    delayUi.delay_mt_before.setText(String(savedDelays.mtBeforeLaunch));
    delayUi.delay_mt_after.setText(String(savedDelays.mtAfterLaunch));
    delayUi.delay_ps_click.setText(String(savedDelays.psClick));
    delayUi.delay_before_input.setText(String(savedDelays.beforeInput));
    delayUi.delay_save_click1.setText(String(savedDelays.saveClick1));
    delayUi.delay_save_click2.setText(String(savedDelays.saveClick2));
    delayUi.delay_save_final.setText(String(savedDelays.saveFinal));
    var dialog = dialogs.build({ customView: delayUi, wrapInScrollView: true, autoDismiss: false }).show();
    delayUi.btn_save_delay.on("click", function() {
        var newDelays = {
            psLaunch: parseInt(delayUi.delay_ps_launch.getText()) || 1000,
            mtBeforeLaunch: parseInt(delayUi.delay_mt_before.getText()) || 1000,
            mtAfterLaunch: parseInt(delayUi.delay_mt_after.getText()) || 700,
            psClick: parseInt(delayUi.delay_ps_click.getText()) || 1500,
            beforeInput: parseInt(delayUi.delay_before_input.getText()) || 850,
            saveClick1: parseInt(delayUi.delay_save_click1.getText()) || 800,
            saveClick2: parseInt(delayUi.delay_save_click2.getText()) || 100,
            saveFinal: parseInt(delayUi.delay_save_final.getText()) || 500
        };
        configStorage.put("delays", newDelays);
        toast("Âª∂ËøüËÆæÁΩÆÂ∑≤‰øùÂ≠ò");
        dialog.dismiss();
    });
    delayUi.btn_close_delay.on("click", function() { dialog.dismiss(); });
}

// --- ‰ª•‰∏ãÊòØUIÊéßÂà∂ÂíåÈ™åËØÅÈÄªËæë ---
var colorPrimary = "#667eea", colorWhite = "#ffffff", colorTextPrimary = "#2c3e50", colorTextHint = "#7f8c8d", colorBgLight = "#f8f9fa", colorBgGrey = "#ecf0f1", colorGreen = "#27ae60", colorGrey = "#95a5a6", colorBlue = "#3498db", colorRed = "#e74c3c", colorInactiveTab = "#A0A0A0";
function applyColorStyles() {
    ui.run(function() {
        ui.pages_container.setBackgroundColor(colors.parseColor(colorBgLight));
        ui.title_bar.setBackgroundColor(colors.parseColor(colorPrimary));
        ui.title_text.setTextColor(colors.parseColor(colorWhite));
        ui.subtitle_text.setTextColor(colors.parseColor("#e8e8ff"));
        ui.nav_bar.setBackgroundColor(colors.parseColor(colorWhite));
        ui.nav_indicator.setBackgroundColor(colors.parseColor(colorBgGrey));
        var containers = ["container_size", "container_pos", "container_zoom", "container_advanced", "container_module_pool", "container_current_workflow", "container_ps_order", "container_mt_order", "container_preprocess", "container_delay", "container_about", "container_performance"];
        containers.forEach(function(id) { if (ui[id]) { ui[id].setBackgroundColor(colors.parseColor(colorWhite)); } });
        ui.status_text.setBackgroundColor(colors.parseColor(colorBgGrey));
        ui.status_text.setTextColor(colors.parseColor(colorTextHint));
        ui.btn_reverse.setTextColor(colors.parseColor(colorBlue));
        ui.btn_forward.setTextColor(colors.parseColor(colorBlue));
        ui.btn_clear.setTextColor(colors.parseColor(colorRed));
        ui.btn_preprocess.setTextColor(colors.parseColor(colorWhite));
        ui.btn_delay.setBackgroundColor(colors.parseColor(colorBlue));
        ui.btn_delay.setTextColor(colors.parseColor(colorWhite));
        ui.bottom_bar.setBackgroundColor(colors.parseColor(colorWhite));
        ui.btn_start.setTextColor(colors.parseColor(colorWhite));
    });
}
var pages = [ui.page_main, ui.page_advanced, ui.page_sequence, ui.page_settings];
var tabs = [ui.tab_main, ui.tab_advanced, ui.tab_sequence, ui.tab_settings];
function switchTab(index) {
    pages.forEach(function(page, i) { page.attr("visibility", i === index ? "visible" : "gone"); });
    tabs.forEach(function(tab, i) { tab.setTextColor(colors.parseColor(i === index ? colorPrimary : colorInactiveTab)); });
}
function updateButtonState(button, isEnabled) {
    button.setEnabled(isEnabled);
    button.setBackgroundColor(colors.parseColor(isEnabled ? colorGreen : colorGrey));
}
function validateAllInputs() {
    var psOrder = ui.input_order.getText().toString().trim();
    var mtOrder = ui.input_mt_order.getText().toString().trim();
    if (psOrder === '' || mtOrder === '') return false;
    if (psOrder.split(',').length !== mtOrder.split(',').length) {
        ui.status_text.setText("Áä∂ÊÄÅ: PSÂíåMTÂ∫èÂè∑Êï∞Èáè‰∏ç‰∏ÄËá¥ÔºÅ");
        return false;
    }
    ui.status_text.setText("Áä∂ÊÄÅ: ÂèÇÊï∞Ê£ÄÊü•ÈÄöËøáÔºåÂèØ‰ª•ÂêØÂä®");
    return true;
}
function validatePreprocessInput() {
    var order = ui.input_preprocess_order.getText().toString().trim();
    return order !== '';
}
function attachValidationListeners() {
    var allInputs = [ui.input_w, ui.input_h, ui.input_x, ui.input_y, ui.input_z_start, ui.input_z, ui.input_z_end, ui.input_bg_width, ui.input_bg_height, ui.input_opacity, ui.input_blendmode, ui.fadein_end, ui.fadeout_start, ui.input_order, ui.input_mt_order];
    allInputs.forEach(function(input) { if (input) input.on('text_changed', function() { updateButtonState(ui.btn_start, validateAllInputs()); }); });
    ui.input_preprocess_order.on('text_changed', function() { updateButtonState(ui.btn_preprocess, validatePreprocessInput()); });
}
function updateWorkflowDisplay() {
    if (currentWorkflow.length === 0) { ui.workflow_display.setText("ËØ∑‰ªé‰∏äÊñπÁÇπÂáªÊ®°ÂùóÊù•ÊûÑÂª∫ÊµÅÁ®ã..."); }
    else { ui.workflow_display.setText(currentWorkflow.map(function(id) { return stepMap[id] ? stepMap[id].name : 'Êú™Áü•'; }).join(' ‚Üí ')); }
}
function createModuleButtons() {
    ui.module_buttons_container.removeAllViews();
    for (var stepId in stepMap) {
        (function(id) {
            var button = ui.inflate(<button style="Widget.AppCompat.Button.Colored" margin="4dp" padding="12dp" textSize="12sp"/>);
            button.setText(stepMap[id].name);
            button.on('click', function() {
                currentWorkflow.push(id);
                updateWorkflowDisplay();
            });
            ui.module_buttons_container.addView(button);
        })(stepId);
    }
}

// --- UIÂàùÂßãÂåñ ---
applyColorStyles();
switchTab(0);
tabs.forEach(function(tab, index) { tab.on("click", function() { switchTab(index); }); });
createModuleButtons();
updateWorkflowDisplay();
ui.btn_reset_workflow.on('click', function() { currentWorkflow = defaultWorkflow.slice(); updateWorkflowDisplay(); toast("Â∑•‰ΩúÊµÅÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§"); });
ui.btn_clear_workflow.on('click', function() { currentWorkflow = []; updateWorkflowDisplay(); toast("Â∑•‰ΩúÊµÅÂ∑≤Ê∏ÖÁ©∫"); });
ui.btn_reverse.on("click", function() { var nums = ui.input_order.getText().toString().split(',').map(function(i) { return i.trim(); }).filter(function(i) { return i; }); if (nums.length > 0) { ui.input_order.setText(nums.reverse().join(',')); } });
ui.btn_forward.on("click", function() { ui.input_order.setText("0,1,2,3,4,5,6,7,8,9"); });
ui.btn_clear.on("click", function() { ui.input_order.setText(''); });
ui.switch_fast_input.on('check', function(checked) { 
    ui.container_fast_input_settings.attr("visibility", checked ? "visible" : "gone");
    ui.container_slow_motion.attr("visibility", checked ? "visible" : "gone");
});
ui.btn_delay.on("click", openDelaySettings);
ui.btn_start.on('click', function() { launchWorker('main'); });
ui.btn_preprocess.on('click', function() { launchWorker('preprocess'); });
attachValidationListeners();
updateButtonState(ui.btn_start, validateAllInputs());
updateButtonState(ui.btn_preprocess, validatePreprocessInput());